---
permalink: /:categories/:year/:month/:title.html
layout: post
title: Measuring coverage for Unit and Integration tests with Maven, Jenkins, and
  SonarQube
date: '2014-02-17T08:46:00.001-08:00'
author: Andres Olarte
tags:
- continuous-integration
- jenkins
- maven
- java
modified_time: '2014-09-13T17:19:47.425-07:00'
thumbnail: http://1.bp.blogspot.com/-6qEkfxC6U-o/UwIjsHSrX6I/AAAAAAAAAYU/kQRwBeD2N5A/s72-c/install+sonar+plugin.png
blogger_id: tag:blogger.com,1999:blog-3306197464901287625.post-3741338912574598563
blogger_orig_url: http://www.javaprocess.com/2014/02/measuring-coverage-for-unit-and.html
---

Measuring coverage for Unit and Integration tests with Maven, Jenkins, and SonarQube. This blog post provides a very simple example of integrating Maven, Jenkins, and SonarQube, in particular to properly get coverage metrics of integration tests.   While the basic integration  Maven, Jenkins, and SonarQube was really simple (including code coverage metrics during unit tests, getting the integration data to display in Sonar was more complicated, and required me to piece together this configuration from several posts around the internet.<br /><br />These tools are very easy to install, and provide the basic framework for serious quality development. Hopefully you will find this information useful.<br /><br />This tutorial assumes that you have installed and setup the following tools:<br /><br /><ul><li><a href="http://maven.apache.org/">Maven</a> A Java build management system.</li><li><a href="http://jenkins-ci.org/">Jenkins</a> A continuous integration (CI) system</li><li><a href="http://www.sonarqube.org/">SonarQube</a> A software quality mangement system. &nbsp;&nbsp;</li></ul>If you want some pointers on getting these tools setup, you can find plenty of resources in the web:<br /><br /><br /><ul><li><a href="http://maven.apache.org/download.cgi">Maven download and installation</a></li><li><a href="https://wiki.jenkins-ci.org/display/JENKINS/Installing+Jenkins">Jenkins installation</a></li><li><a href="http://docs.codehaus.org/display/SONAR/Setup+and+Upgrade">Sonar installation</a></li></ul><br /><h3>Project setup&nbsp;</h3>We will start looking at the pom.xml, which is most critical part of this tutorial.  If you're familiar with Jenkins a and Sonar, the rest of this tutorial might be redudant for you.<br /><b>pom.xml</b><br /><pre class="brush: xml">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"<br />         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;<br />    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;<br />    &lt;groupId&gt;test.tutorials.multi&lt;/groupId&gt;<br />    &lt;artifactId&gt;mod2&lt;/artifactId&gt;<br />    &lt;packaging&gt;jar&lt;/packaging&gt;<br />    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;<br />    &lt;name&gt;Coverage Maven Application&lt;/name&gt;<br /><br /><br />    &lt;properties&gt;<br />        &lt;sonar.jacoco.itReportPath&gt;${env.WORKSPACE}/target/jacoco-integration.exec&lt;/sonar.jacoco.itReportPath&gt; &lt;!-- 1 --&gt;<br />    &lt;/properties&gt;<br /><br />    &lt;build&gt;<br />        &lt;plugins&gt;<br /><br /><br />            &lt;plugin&gt;<br />                &lt;groupId&gt;org.jacoco&lt;/groupId&gt;<br />                &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;<br />                &lt;configuration&gt;<br />                    &lt;propertyName&gt;jacoco.agent.argLine&lt;/propertyName&gt; &lt;!-- 2 --&gt;<br />                    &lt;destFile&gt;${project.build.directory}/jacoco-integration.exec&lt;/destFile&gt; <br />                    &lt;dataFile&gt;${project.build.directory}/jacoco-integration.exec&lt;/dataFile&gt; &lt;!-- 3 --&gt;<br />                &lt;/configuration&gt;<br />                &lt;executions&gt;<br />                    &lt;execution&gt;<br />                        &lt;id&gt;agent&lt;/id&gt;<br />                        &lt;goals&gt;<br />                            &lt;goal&gt;prepare-agent&lt;/goal&gt; &lt;!-- 4 --&gt;<br />                        &lt;/goals&gt;<br />                    &lt;/execution&gt;<br />                &lt;/executions&gt;<br />            &lt;/plugin&gt;<br /><br />            &lt;plugin&gt;<br />                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;<br />                &lt;version&gt;2.6&lt;/version&gt;<br />                &lt;configuration&gt;<br />                    &lt;argLine&gt;${jacoco.agent.argLine}&lt;/argLine&gt; &lt;!-- 5 --&gt;<br />                    &lt;reportsDirectory&gt;${project.build.directory}/surefire-reports&lt;/reportsDirectory&gt; &lt;!-- 6 --&gt;                 <br />                &lt;/configuration&gt;<br />                &lt;executions&gt;<br />                    &lt;execution&gt;<br />                        &lt;goals&gt;<br />                            &lt;goal&gt;integration-test&lt;/goal&gt; <br />                            &lt;goal&gt;verify&lt;/goal&gt; &lt;!-- 7 --&gt;<br />                        &lt;/goals&gt;<br />                    &lt;/execution&gt;<br />                &lt;/executions&gt;<br />            &lt;/plugin&gt;           <br /><br />        &lt;/plugins&gt;<br />    &lt;/build&gt;<br /><br /><br />    &lt;dependencies&gt;<br />        &lt;dependency&gt;<br />            &lt;groupId&gt;junit&lt;/groupId&gt;<br />            &lt;artifactId&gt;junit&lt;/artifactId&gt;<br />            &lt;version&gt;4.11&lt;/version&gt;<br />            &lt;scope&gt;test&lt;/scope&gt;<br />        &lt;/dependency&gt;<br /><br />    &lt;/dependencies&gt;<br /><br />&lt;/project&gt;<br /></pre><ol><li>This property lets sonar know where to find JaCoCo reports for the integration tests. The ${env.WORKSPACE} prefix enables the Sonar plugin to find these files.</li><li>The JVM argument required to inject JaCoCo into the integration tests with be stored in a property named jacoco.agent.argLine .</li><li>The destFile and dataFile properties indicate where JaCoCo will output its files.</li><li>The <pre>prepare-agent</pre>goal will setup the JVM argument that we will reuse later.</li><li>Property will inject the required JVM arguments to enable JaCoCo integration.  Since JaCoCo does instrumentation at runtime, building and injecting the proper parameters is all that's required to get coverage information.</li><li>Changing the reportsDirectory property is optional, and will cause the Failsafe plugin to output it's results to the same directory used by the Surefire plugin.  The Surefire plugin executes Unit Tests in Maven, and it's results are read by SonarQube, and displayed as "Unit test success". Sending Failsafe's results to the Surefire report directory will trick Sonar into display the information.  If you have a CI server such as Jenkins displaying this information, this "trick" might be superfluous.</li><li>The Failsafe plugin will run in the integration-test and verify goals.</li></ol><div><br /></div><div>Other than the pom.xml, the test project includes to very basic tests, a unit test, and an integration test. Each one covers 50% of the classes in the projects. &nbsp;You can get the complete source code <a href="https://github.com/aolarte/tutorials.git">here</a>. You will find a minimal example from which you can work up.</div><h3>Setting up a job with Sonar support in Jenkins</h3><div>There's several ways of running SonarQube against a project:</div><div><ul><li>Using the SonarQube plugin for Jenkins</li><li>Using the stand alone SonarQube Runner</li><li>Adding it to your Maven (or Ant) build</li></ul><div>In this tutorial we will use the first option. &nbsp;Personally I prefer to keep the pom as clean as possible, and have Jenkins perform extra steps such as analyzing code quality, deployment into package managers, etc.<br /><br />Make sure that you install the Jenkins SonarQube plugin:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-6qEkfxC6U-o/UwIjsHSrX6I/AAAAAAAAAYU/kQRwBeD2N5A/s1600/install+sonar+plugin.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-6qEkfxC6U-o/UwIjsHSrX6I/AAAAAAAAAYU/kQRwBeD2N5A/s1600/install+sonar+plugin.png" height="410" width="640" /></a></div><br />The SonarQube plugin must be configured with one or Sonar installation. &nbsp;Most shops will only have one Sonar installation. &nbsp;This can be done in "Manage Jenkins" -&gt; "Configure System"<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-gw5DMhLgEPQ/UwIjsI2zhCI/AAAAAAAAAYY/x4IYRg-hPMs/s1600/sonar+config.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-gw5DMhLgEPQ/UwIjsI2zhCI/AAAAAAAAAYY/x4IYRg-hPMs/s1600/sonar+config.png" height="504" width="640" /></a></div><br />In this case, we're using the defaults, since our SonarQube installation is running on http://localhost:9000, and we're using the embedded database, so there's no need to configure any of the database information.<br /><br />It is also useful to check "Skip if triggered by SCM Changes" and "Skip if triggered by the build of a dependency", to prevent Sonar running after every commit. &nbsp;Running Sonar once a night is normally enough for most projects. &nbsp;This assumes that you have one nightly build scheduled for every project that you want to analyze with SonarQube.<br /><br />We will then set up a simple Maven job in Jenkins:<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-UvmwGTNCero/UwIZYu17D7I/AAAAAAAAAXw/n0bQmtOqFdY/s1600/new+project.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-UvmwGTNCero/UwIZYu17D7I/AAAAAAAAAXw/n0bQmtOqFdY/s1600/new+project.png" height="376" width="640" /></a></div><br />We will check this project out of Source Control Management. &nbsp;I'm going to use SVN to access a directory inside my git repository. &nbsp;For real projects, I would recommend having a one git repository per each project:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-ZfvzoNCmykQ/UwIZZDHJRKI/AAAAAAAAAYE/EI0CJQ51ovg/s1600/svn.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-ZfvzoNCmykQ/UwIZZDHJRKI/AAAAAAAAAYE/EI0CJQ51ovg/s1600/svn.png" height="444" width="640" /></a></div><br />Finally, we just add a "Post-build Action", to invoke SonarQube. &nbsp;This will use the configuration for the SonarQube instance we configured before.<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-NrjfP40DfT4/UwIZYrWCLwI/AAAAAAAAAX0/4AtOHx3a0uk/s1600/sonar.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-NrjfP40DfT4/UwIZYrWCLwI/AAAAAAAAAX0/4AtOHx3a0uk/s1600/sonar.png" height="444" width="640" /></a></div><br /><br />Finally you can start a build manually. &nbsp;This will cause to project to first be built as usual using Maven, and the analyzed by Sonar:<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-QQynaZ-_5mw/UwIZYpqqV8I/AAAAAAAAAX8/IywMrM2F2ws/s1600/start+a+build.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://2.bp.blogspot.com/-QQynaZ-_5mw/UwIZYpqqV8I/AAAAAAAAAX8/IywMrM2F2ws/s1600/start+a+build.png" height="444" width="640" /></a></div><br /><h3>The results</h3></div></div><div>After the build is run successfully by Jenkins, you can see the results on your SonarQube installation. &nbsp;Make sure that you have the "Integration Tests Coverage" widget in your dashboard. &nbsp;To add it, log into SonarQube, and click on "Configure widgets".<br /><br /><div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;"><a href="http://3.bp.blogspot.com/-0GZndfmpS5I/UwI54Xa3jrI/AAAAAAAAAY4/RrpUC3bt6_E/s1600/sonar_result.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://3.bp.blogspot.com/-0GZndfmpS5I/UwI54Xa3jrI/AAAAAAAAAY4/RrpUC3bt6_E/s1600/sonar_result.png" height="564" width="640" /></a></div><br />You can see how Test Coverage for Integration Tests is reported separately, and that there's a metric for "Overall Coverage", which joins the coverage for unit tests and integration tests. &nbsp;If you drill down can see much more detail about your project, so I encourage to click around and see what Sonar has to say about your code.</div><h3 id="source">Source Code</h3>As always the code is available for you to download and play with. Clone it from it from github:<br /><pre>git clone https://github.com/aolarte/tutorials.git<br /></pre>The finished code is contained in directory <strong>coverage</strong>.<br /><br /><h3>References</h3><div>This post was put together with tidbits of information from other postings around the net:<br /><br /><br /><ul><li><a href="http://theholyjava.wordpress.com/2012/02/05/separating-integration-and-unit-tests-with-maven-sonar-failsafe-and-jacoco/">Separating Integration and Unit Tests with Maven, Sonar, Failsafe, and JaCoCo</a></li><li><a href="http://davidvaleri.wordpress.com/2013/09/06/tracking-integration-test-coverage-with-maven-and-sonarqube/">Tracking Integration Test Coverage with Maven and SonarQube</a></li><li><a href="http://www.agile-engineering.net/2012/05/easy-unit-and-integration-code-coverage.html">Easy Unit and Integration Code Coverage</a></li></ul></div><div><br /></div>